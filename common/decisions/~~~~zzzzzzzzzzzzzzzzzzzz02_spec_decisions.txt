# Market Candidate Nomination
# check for is_megacorp and is_gestalt
decision_market_nomination = {
	owned_planets_only = yes

	# instant
	
	resources = {
		category = decisions
		cost = {
			energy = 1000
			influence = 150
		}
	}
	
	potential = {
		OR = {
			has_global_flag = ongoing_market_nomination
			has_global_flag = ongoing_market_relocation_nomination
		}
		#from = { has_communications = event_target:50percentcomms } # should include self
		from = { has_country_flag = market_nomination_eligible }
	}
	
	allow = {
		num_pops > 20
		custom_tooltip = {
			fail_text = already_market_nominated
			from = {
				NOT = {
					any_owned_planet = {
						OR = {
							has_modifier = market_nominee_level_1
							has_modifier = market_nominee_level_2
							has_modifier = market_nominee_level_3
							has_modifier = market_nominee_level_4 # boosted once
							has_modifier = market_nominee_level_5 # boosted twice
						}
					}
				}
			}
		}
	}
	
	effect = {
		custom_tooltip = decision_market_nomination_effects
		hidden_effect = {
			from = {
				set_variable = {
					which = market_rating
					value = 0
				}
			}
			random_list = {
				9 = {
					add_modifier = {
						modifier = market_nominee_level_1
						days = -1
					}
					from = {
						change_variable = {
							which = market_rating
							value = 1
						}
					}
					modifier = {
						factor = 0.33
						from = { is_megacorp = yes }
					}
					modifier = {
						factor = 0.33
						from = { trade_income >= 100 }
					}
					modifier = {
						factor = 2
						from = { trade_income <= 50 }
					}
					modifier = {
						factor = 1.5
						from = { is_gestalt = yes }
					}
				}
				6 = {
					add_modifier = {
						modifier = market_nominee_level_2
						days = -1
					}
					from = {
						change_variable = {
							which = market_rating
							value = 2
						}
					}
				}
				1 = {
					modifier = {
						factor = 200
						is_planet_class = pc_city
					}
					modifier = {
						factor = 9
						from = { is_megacorp = yes }
					}
					modifier = {
						factor = 2
						from = { trade_income >= 120 }
					}
					modifier = {
						factor = 0.5
						from = { trade_income <= 50 }
					}
					modifier = {
						factor = 0.75
						from = { is_gestalt = yes }
					}
					add_modifier = {
						modifier = market_nominee_level_3
						days = -1
					}
					from = {
						change_variable = {
							which = market_rating
							value = 3
						}
					}
				}
			}
		}
	}
	
	ai_weight = {
		weight = 10
		modifier = {
			factor = 0
			num_pops < 20
		}
		modifier = {
			factor = 1.5
			from = {
				resource_stockpile_compare = {
					resource = energy
					value > 12000
				}
				resource_stockpile_compare = {
					resource = influence
					value > 400
				}
			}
		}
		modifier = {
			factor = 0.8
			from = { is_xenophobe = yes }
		}
		modifier = {
			factor = 2
			from = { is_megacorp = yes }
		}
	}
}

# check for is_megacorp
decision_boost_market_nomination = {
	owned_planets_only = yes
	resources = {
		category = decisions
		cost = {
			energy = 2000
			influence = 300
		}
	}
	
	potential = {
		OR = {
			has_global_flag = ongoing_market_nomination
			has_global_flag = ongoing_market_relocation_nomination
		}
		#from = { has_communications = event_target:50percentcomms } # should include self
		from = { has_country_flag = market_nomination_eligible }
		OR = {
			has_modifier = market_nominee_level_1
			has_modifier = market_nominee_level_2
			has_modifier = market_nominee_level_3
			has_modifier = market_nominee_level_4 # maxed out and boosted once
			has_modifier = market_nominee_level_5 # maxed out and boosted twice
		}
	}
	
	allow = {
		custom_tooltip = {
			fail_text = max_boosted
			NOT = { has_planet_flag = boosted_twice }
		}
	}
	
	effect = {
		custom_tooltip = decision_boost_market_nomination_effects
		hidden_effect = {
			# boost counter
			if = {
				limit = { has_planet_flag = boosted_once }
				set_planet_flag = boosted_twice
			}
			else = {
				set_planet_flag = boosted_once
			}
			# boost rating
			if = {
				limit = { has_modifier = market_nominee_level_1 }
				remove_modifier = market_nominee_level_1
				add_modifier = {
					modifier = market_nominee_level_2
					days = -1
				}
			}
			else_if = {
				limit = { has_modifier = market_nominee_level_2 }
				remove_modifier = market_nominee_level_2
				add_modifier = {
					modifier = market_nominee_level_3
					days = -1
				}
			}
			else_if = {
				limit = { has_modifier = market_nominee_level_3 }
				remove_modifier = market_nominee_level_3
				add_modifier = {
					modifier = market_nominee_level_4
					days = -1
				}
			}
			else_if = {
				limit = { has_modifier = market_nominee_level_4 }
				remove_modifier = market_nominee_level_4
				add_modifier = {
					modifier = market_nominee_level_5
					days = -1
				}
			}
			from = {
				change_variable = {
					which = market_rating
					value = 1
				}
			}
		}
	}
	
	ai_weight = {
		weight = 10
		modifier = {
			factor = 0
			num_pops < 20
		}
		modifier = {
			factor = 1.5
			from = {
				resource_stockpile_compare = {
					resource = energy
					value > 11000
				}
				resource_stockpile_compare = {
					resource = influence
					value > 350
				}
			}
		}
		modifier = {
			factor = 0.8
			from = { is_xenophobe = yes }
		}
		modifier = {
			factor = 2
			from = { is_megacorp = yes }
		}
	}
}

# Checks is_gestalt
decision_introduce_chaos = {
	owned_planets_only = yes
	icon = decision_victorious_army
	
	enactment_time = 1800
	resources = {
		category = decisions
		cost = {
			energy = 500
		}
	}
	potential = {
		has_planet_flag = perfect_organization
		exists = owner
		owner = { is_gestalt = no }
	}
	
	effect = {
		remove_modifier = perfect_organization_modifier
		add_modifier = { modifier = imperfect_organization_modifier }
		remove_planet_flag = perfect_organization
	}
	ai_weight = {
		weight = 1
	}
}

# Making the decision available on all modded habitats
decision_consecrate_habitat_knights = {
	owned_planets_only = yes

	enactment_time = 360
	
	potential = {
		owner = {
			has_origin = origin_toxic_knights
			has_relic = r_toxic_god
		}
		merg_is_habitat = yes
		NOR = {
			has_building = building_order_castle
			has_building = building_order_keep
		}
	}
	
	allow = {
		free_building_slots > 0
		custom_tooltip = {
			fail_text = requires_another_consecration
			owner = {
				check_variable = {
					which = toxic_castles_available
					value > 0
				}
			}
		}
	}
	
	on_queued = {
		owner = {
			change_variable = {
				which = toxic_castles_available
				value = 1
			}
		}
	}
	
	on_unqueued = {
		owner = {
			change_variable = {
				which = toxic_castles_available
				value = -1
			}
		}
	}
	
	resources = {
		category = decisions
		cost = {
			influence = 50
		}
	}
	
	effect = {
		add_building = building_order_castle
		custom_tooltip = decision_consecrate_habitat_knights_effect
	}
}
